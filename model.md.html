<body>
    <link href="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/prism/9000.0.1/themes/prism.min.css" rel="stylesheet">

    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script src="https://cdn.bootcss.com/prism/9000.0.1/prism.min.js"></script>
    
    
    <script src="https://cdn.bootcss.com/babel-polyfill/7.0.0-alpha.20/polyfill.min.js"></script>
    <script src="https://cdn.bootcss.com/require.js/2.3.5/require.min.js"></script>
    
    <script type="es5-code">
    requirejs(['react', 'antd', 'vanex'], function (_react, _antd, _vanex) {
  'use strict';

  var _react2 = _interopRequireDefault(_react);

  function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
      default: obj
    };
  }

  function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
      throw new TypeError("Cannot call a class as a function");
    }
  }

  var _createClass = function () {
    function defineProperties(target, props) {
      for (var i = 0; i < props.length; i++) {
        var descriptor = props[i];
        descriptor.enumerable = descriptor.enumerable || false;
        descriptor.configurable = true;
        if ("value" in descriptor) descriptor.writable = true;
        Object.defineProperty(target, descriptor.key, descriptor);
      }
    }

    return function (Constructor, protoProps, staticProps) {
      if (protoProps) defineProperties(Constructor.prototype, protoProps);
      if (staticProps) defineProperties(Constructor, staticProps);
      return Constructor;
    };
  }();

  function _possibleConstructorReturn(self, call) {
    if (!self) {
      throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    }

    return call && (typeof call === "object" || typeof call === "function") ? call : self;
  }

  function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
      throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);
    }

    subClass.prototype = Object.create(superClass && superClass.prototype, {
      constructor: {
        value: subClass,
        enumerable: false,
        writable: true,
        configurable: true
      }
    });
    if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;
  }

  var _dec, _class, _dec2, _class2, _dec3, _class3;

  function _asyncToGenerator(fn) {
    return function () {
      var gen = fn.apply(this, arguments);
      return new Promise(function (resolve, reject) {
        function step(key, arg) {
          try {
            var info = gen[key](arg);
            var value = info.value;
          } catch (error) {
            reject(error);
            return;
          }

          if (info.done) {
            resolve(value);
          } else {
            return Promise.resolve(value).then(function (value) {
              step("next", value);
            }, function (err) {
              step("throw", err);
            });
          }
        }

        return step("next");
      });
    };
  }

  var TabPane = _antd.Tabs.TabPane;

  var userModel = {
    name: 'userModel',
    data: {
      username: 'codefalling'
    },
    syncs: {
      setName: function setName(val) {
        this.username = val;
      }
    }
  };

  var detailModel = {
    name: 'detailModel',
    data: {
      fetchedData: {},
      isLoading: false,
      isDataOutDated: false
    },
    effects: {
      fetch: function (_fetch) {
        function fetch(_x) {
          return _fetch.apply(this, arguments);
        }

        fetch.toString = function () {
          return _fetch.toString();
        };

        return fetch;
      }(function (username) {
        var _this = this;

        return _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
          var API, res, data;
          return regeneratorRuntime.wrap(function _callee$(_context) {
            while (1) {
              switch (_context.prev = _context.next) {
                case 0:
                  API = 'https://api.github.com/users/' + username;

                  _this.isLoading = true;
                  _context.next = 4;
                  return fetch(API);

                case 4:
                  res = _context.sent;
                  _context.next = 7;
                  return res.json();

                case 7:
                  data = _context.sent;

                  _this.isLoading = false;
                  _this.isDataOutDated = false;
                  _this.fetchedData = data;

                case 11:
                case 'end':
                  return _context.stop();
              }
            }
          }, _callee, _this);
        }))();
      })
    },
    computed: {
      get dataSource() {
        if (this.fetchedData && this.fetchedData.login) {
          var data = this.fetchedData;
          return [{
            key: 1,
            name: data.name,
            avatar: data.avatar_url,
            followers: data.followers
          }];
        }
      }
    }
  };

  // 定义 Model 间的关联
  var relation = new _vanex.Relation();

  relation.autorun(function (context) {
    if (context.userModel.username) {
      // context 相当于注入了所有的 Model，可以跨 Model 进行通信
      context.detailModel.isDataOutDated = true;
    }
  });

  var NameChanger = (_dec = (0, _vanex.vanex)('userModel'), _dec(_class = function (_React$Component) {
    _inherits(NameChanger, _React$Component);

    function NameChanger() {
      _classCallCheck(this, NameChanger);

      return _possibleConstructorReturn(this, (NameChanger.__proto__ || Object.getPrototypeOf(NameChanger)).apply(this, arguments));
    }

    _createClass(NameChanger, [{
      key: 'render',
      value: function render() {
        var userModel = this.userModel;
        var username = userModel.username;

        return _react2.default.createElement(_antd.Input, {
          value: username,
          style: { width: '130px' },
          onChange: function onChange(e) {
            return userModel.setName(e.target.value);
          }
        });
      }
    }]);

    return NameChanger;
  }(_react2.default.Component)) || _class);
  var DetailView = (_dec2 = (0, _vanex.vanex)('detailModel', 'userModel'), _dec2(_class2 = function (_React$Component2) {
    _inherits(DetailView, _React$Component2);

    function DetailView() {
      _classCallCheck(this, DetailView);

      var _this3 = _possibleConstructorReturn(this, (DetailView.__proto__ || Object.getPrototypeOf(DetailView)).apply(this, arguments));

      _this3.clickHandler = _this3.clickHandler.bind(_this3);
      return _this3;
    }

    _createClass(DetailView, [{
      key: 'clickHandler',
      value: function clickHandler(e) {
        this.detailModel.fetch(this.userModel.username);
      }
    }, {
      key: 'componentDidMount',
      value: function componentDidMount() {
        this.detailModel.fetch(this.userModel.username);
      }
    }, {
      key: 'render',
      value: function render() {
        var _detailModel = this.detailModel,
            fetchedData = _detailModel.fetchedData,
            isLoading = _detailModel.isLoading,
            dataSource = _detailModel.dataSource,
            isDataOutDated = _detailModel.isDataOutDated;

        var columns = [{
          title: '用户名',
          dataIndex: 'name'
        }, {
          title: '头像',
          dataIndex: 'avatar',
          render: function render(text) {
            return _react2.default.createElement('img', { style: { width: '80px' }, src: text });
          }
        }, {
          title: 'followers',
          dataIndex: 'followers'
        }];
        return _react2.default.createElement(
          'div',
          null,
          _react2.default.createElement(
            _antd.Button,
            { type: 'primary', loading: isLoading, onClick: this.clickHandler },
            isDataOutDated ? '用户名已改变，请点击重新获取用户信息' : '获取用户信息'
          ),
          dataSource ? _react2.default.createElement(
            'div',
            null,
            _react2.default.createElement(
              'h2',
              null,
              '\u7528\u6237\u4FE1\u606F'
            ),
            _react2.default.createElement(_antd.Table, { columns: columns, dataSource: dataSource })
          ) : null
        );
      }
    }]);

    return DetailView;
  }(_react2.default.Component)) || _class2);
  var ContainerComponent = (_dec3 = (0, _vanex.vanex)('userModel'), _dec3(_class3 = function (_React$Component3) {
    _inherits(ContainerComponent, _React$Component3);

    function ContainerComponent() {
      _classCallCheck(this, ContainerComponent);

      return _possibleConstructorReturn(this, (ContainerComponent.__proto__ || Object.getPrototypeOf(ContainerComponent)).apply(this, arguments));
    }

    _createClass(ContainerComponent, [{
      key: 'render',
      value: function render() {
        var userModel = this.userModel;

        return _react2.default.createElement(
          'div',
          null,
          '\u7528\u6237 ID:',
          userModel.username,
          _react2.default.createElement(
            'h1',
            null,
            'UserModel'
          ),
          _react2.default.createElement(NameChanger, null),
          _react2.default.createElement(
            'h1',
            null,
            'UserModel & DetailModel'
          ),
          _react2.default.createElement(DetailView, null)
        );
      }
    }]);

    return ContainerComponent;
  }(_react2.default.Component)) || _class3);


  (0, _vanex.start)({
    component: ContainerComponent,
    container: '#mountNode',
    models: {
      // 注册模型
      userModel: userModel,
      detailModel: detailModel
    },
    relation: relation
  });
});
    </script>
    <style>
    @import 'https://unpkg.com/antd/dist/antd.css';
    html {
        overflow-y: hidden;
    }
    #__tabs__ {
        height: 100%;
        border: none;
    }

    #__js_tab__ pre, #__css_tab__ pre {
        white-space: inherit;
    }

    #__js_tab__, #__css_tab__ {
        height: 90%;
        overflow-y: scroll;
    }
    
    #__tabs__ .ui-widget-header {
        position: fixed;
        top: 0;
        left: 0;
        border-radius: 0;
        width: 100%;
    }
    #__tabs__>div {
        margin-top: 2em;
    }
    </style> 

    <a style="position: fixed;bottom: 0px;right: 0px;z-index: 99999;" href="model.md.html" target="_blank">Open in new Tab</a>
    <div id="__tabs__">
    <ul>
      <li><a href="#__preview_tab__">Preview</a></li>
      <li><a href="#__js_tab__">JS</a></li>
      <li><a href="#__css_tab__">CSS</a></li>
    </ul>
    <div id="__preview_tab__">
    <div style="padding: 15px">
        <div id="mountNode">
        </div>
    </div>
    </div>
    <div id="__js_tab__">
    <pre>
        <code class="language-javascript">import React from &#39;react&#39;;
import { Tabs, Input, Button, Table } from &#39;antd&#39;;
const TabPane &#x3D; Tabs.TabPane;

import { vanex, start, Relation } from &#39;vanex&#39;;

const userModel &#x3D; {
  name: &#39;userModel&#39;,
  data: {
    username: &#39;codefalling&#39;,
  },
  syncs: {
    setName(val) {
      this.username &#x3D; val;
    },
  },
};

const detailModel &#x3D; {
  name: &#39;detailModel&#39;,
  data: {
    fetchedData: {},
    isLoading: false,
    isDataOutDated: false,
  },
  effects: {
    async fetch(username) {
      const API &#x3D; &#x60;https:&#x2F;&#x2F;api.github.com&#x2F;users&#x2F;${username}&#x60;;
      this.isLoading &#x3D; true;
      const res &#x3D; await fetch(API);
      const data &#x3D; await res.json();
      this.isLoading &#x3D; false;
      this.isDataOutDated &#x3D; false;
      this.fetchedData &#x3D; data;
    },
  },
  computed: {
    get dataSource() {
      if (this.fetchedData &amp;&amp; this.fetchedData.login) {
        const data &#x3D; this.fetchedData;
        return [
          {
            key: 1,
            name: data.name,
            avatar: data.avatar_url,
            followers: data.followers,
          },
        ];
      }
    },
  },
};

&#x2F;&#x2F; 定义 Model 间的关联
const relation &#x3D; new Relation();

relation.autorun(context &#x3D;&gt; {
  if (context.userModel.username) {
    &#x2F;&#x2F; context 相当于注入了所有的 Model，可以跨 Model 进行通信
    context.detailModel.isDataOutDated &#x3D; true;
  }
});

@vanex(&#39;userModel&#39;)
class NameChanger extends React.Component {
  render() {
    const { userModel } &#x3D; this;
    const { username } &#x3D; userModel;
    return (
      &lt;Input
        value&#x3D;{username}
        style&#x3D;{{width: &#39;130px&#39;}}
        onChange&#x3D;{e &#x3D;&gt; userModel.setName(e.target.value)}
      &#x2F;&gt;
    );
  }
}

&#x2F;&#x2F; 同时注册两个 Model
@vanex(&#39;detailModel&#39;, &#39;userModel&#39;)
class DetailView extends React.Component {
  constructor() {
    super(...arguments);
    this.clickHandler &#x3D; this.clickHandler.bind(this);
  }
  
  clickHandler(e) {
    this.detailModel.fetch(this.userModel.username);
  }
  
  componentDidMount() {
    this.detailModel.fetch(this.userModel.username);
  }
  
  render() {
    const { fetchedData, isLoading, dataSource, isDataOutDated } &#x3D; this.detailModel;
    const columns &#x3D; [
      {
        title: &#39;用户名&#39;,
        dataIndex: &#39;name&#39;,
      },
      {
        title: &#39;头像&#39;,
        dataIndex: &#39;avatar&#39;,
        render: (text) &#x3D;&gt; &lt;img style&#x3D;{{width: &#39;80px&#39;}} src&#x3D;{text}&gt;&lt;&#x2F;img&gt;
      },
      {
        title: &#39;followers&#39;,
        dataIndex: &#39;followers&#39;,
      },
    ];
    return (
      &lt;div&gt;
        &lt;Button type&#x3D;&quot;primary&quot; loading&#x3D;{isLoading} onClick&#x3D;{this.clickHandler}&gt;
          { isDataOutDated ? &#39;用户名已改变，请点击重新获取用户信息&#39; : &#39;获取用户信息&#39;}
        &lt;&#x2F;Button&gt;
        {dataSource
          ? &lt;div&gt;
              &lt;h2&gt;用户信息&lt;&#x2F;h2&gt;
              &lt;Table columns&#x3D;{columns} dataSource&#x3D;{dataSource} &#x2F;&gt;
            &lt;&#x2F;div&gt;
          : null}
      &lt;&#x2F;div&gt;
    );
  }
}

@vanex(&#39;userModel&#39;)
class ContainerComponent extends React.Component {
  render() {
    const { userModel } &#x3D; this;
    return (
      &lt;div&gt;
        用户 ID:{userModel.username}
        &lt;h1&gt;UserModel&lt;&#x2F;h1&gt;
         &lt;NameChanger &#x2F;&gt;
        &lt;h1&gt;UserModel &amp; DetailModel&lt;&#x2F;h1&gt;
        &lt;DetailView &#x2F;&gt;
      &lt;&#x2F;div&gt;
    );
  }
}

start({
  component: ContainerComponent,
  container: &#39;#mountNode&#39;,
  models: {
    &#x2F;&#x2F; 注册模型
    userModel,
    detailModel,
  },
  relation,
});
</code>
    </pre>
    </div>
    <div id="__css_tab__">
    <pre>
        <code class="language-css">@import &#39;antd&#x2F;dist&#x2F;antd.css&#39;;</code>
    </pre>
    </div>
  </div>
    <script>
        $( function() {
            $('#__tabs__').tabs();
        } );
        window.mountNode = document.getElementById('mountNode');
        var paths = {
            'react': 'https://cdn.bootcss.com/react/16.0.0-beta.5/umd/react.production.min',
            'react-dom': 'https://cdn.bootcss.com/react/15.6.1/react-dom.min',
            'vanex': 'https://unpkg.com/vanex/lib/vanex.pack.min',
            'antd': 'https://cdn.bootcss.com/antd/3.0.0-alpha0/antd.min',
            'mobx': 'https://cdn.bootcss.com/mobx/3.2.2/mobx.umd.min',
            'redux': 'https://cdn.bootcss.com/redux/3.7.2/redux.min',
            'dva': 'https://unpkg.com/dva@2.0.1/dist/dva-min',
        };
        requirejs.config({
            // module name mapped to CDN url
            paths: paths,
        });

        var load = requirejs.load;
        requirejs.load = function (context, moduleId, url) {
            if (moduleId in paths) {
            } else {
                url = `https://unpkg.com/${moduleId}`;
            }
            return load(context, moduleId, url);
        };

        
        var blocks = document.querySelectorAll('[type="es5-code"]');
        window.require = requirejs;
        function evalCode(code) {
            eval(code);
        }
        
        blocks.forEach(block => {
          const code = block.innerText;
          evalCode(code);
        })

    </script> 
    </body>